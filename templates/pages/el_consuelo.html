<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indicadores de Gestión Localidad de Santa Fé</title>
    
    <!-- Plotly.js para gráficas -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    
    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <!-- Leaflet Omnivore plugin para KML -->
    <script src="https://unpkg.com/leaflet-omnivore@0.3.4/leaflet-omnivore.min.js"></script>
    
    <style>
        :root {
            /* Colores principales */
            --primary-yellow: #fab62d;    /* Amarillo principal */
            --primary-red: #e4032e;       /* Rojo principal */
            --white: #ffffff;             /* Blanco */
            --dark-gray: #333333;         /* Gris oscuro */
            --light-gray: #f5f5f5;        /* Gris claro */
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --border-radius: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--white);
            color: var(--dark-gray);
            line-height: 1.6;
        }

        .header {
            background: var(--primary-red);
            color: var(--white);
            padding: 2rem;
            text-align: center;
            box-shadow: var(--shadow);
            position: relative;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .controls {
            background: var(--white);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            border: 2px solid var(--light-gray);
        }

        .refresh-btn {
            background: linear-gradient(135deg, var(--primary-yellow) 0%, var(--primary-red) 100%);
            color: var(--white);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1rem;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--white);
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            text-align: center;
            border: 2px solid var(--light-gray);
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card h3 {
            color: var(--primary-red);
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .stat-card p {
            color: var(--dark-gray);
            font-weight: 600;
            font-size: 1.1rem;
        }

        .stat-card .icon {
            font-size: 2rem;
            color: var(--primary-yellow);
            margin-bottom: 1rem;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }

        .chart-container {
            background: var(--white);
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            border: 2px solid var(--light-gray);
        }

        .chart-title {
            color: var(--dark-gray);
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border-bottom: 3px solid var(--primary-yellow);
            padding-bottom: 0.5rem;
        }

        .loading {
            text-align: center;
            padding: 4rem;
            color: var(--dark-gray);
        }

        .loading i {
            font-size: 3rem;
            color: var(--primary-yellow);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #ffebee;
            color: var(--primary-red);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--primary-red);
            margin: 1rem 0;
            font-weight: 500;
        }

        .data-table {
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-top: 2rem;
        }

        .data-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--light-gray);
        }

        .data-table th {
            background: var(--primary-red);
            color: var(--white);
            font-weight: 600;
        }

        .data-table tr:hover {
            background: var(--light-gray);
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .container {
                padding: 1rem;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        .menu-btn { 
            position: absolute; 
            top: 1.5rem; 
            left: 2rem; 
            background: var(--primary-red); 
            border: none; 
            color: var(--white); 
            font-size: 2rem; 
            cursor: pointer; 
            z-index: 1001; 
            border-radius: 50px;
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            min-width: 120px;
        }
        
        .menu-btn-text {
            font-size: 1.1rem;
            font-weight: 600;
            display: inline-block;
            white-space: nowrap;
        }
        .side-menu { position: fixed; top: 0; left: -280px; width: 260px; height: 100vh; background: var(--white); box-shadow: 2px 0 12px rgba(0,0,0,0.12); transition: left 0.3s cubic-bezier(.4,0,.2,1); z-index: 1200; display: flex; flex-direction: column; }
        .side-menu.open { left: 0; }
        .side-menu-header { display: flex; justify-content: space-between; align-items: center; padding: 1.2rem 1.5rem 1.2rem 1.5rem; background: var(--primary-red); color: var(--white); font-weight: 700; font-size: 1.2rem; }
        .close-menu { background: transparent; border: none; color: var(--white); font-size: 1.5rem; cursor: pointer; }
        .side-menu ul { list-style: none; padding: 0; margin: 0; }
        .side-menu li { padding: 1rem 1.5rem; border-bottom: 1px solid var(--light-gray); color: var(--dark-gray); cursor: pointer; transition: background 0.2s; }
        .side-menu li:hover { background: var(--light-gray); }
        .menu-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.2); z-index: 1100; display: none; }
        .menu-overlay.open { display: block; }
        @media (max-width: 768px) { 
            .header h1 { font-size: 2rem; } 
            .container { padding: 1rem; } 
            .controls { flex-direction: column; align-items: stretch; } 
            .stats-grid { grid-template-columns: 1fr; } 
            .menu-btn { 
                top: 1rem; 
                left: 1rem; 
                font-size: 1.7rem; 
                padding: 0.5rem 1rem;
                min-width: auto;
                border-radius: 50%;
                width: 48px;
                height: 48px;
            } 
            .menu-btn-text {
                display: none;
            }
            .side-menu { width: 80vw; min-width: 180px; max-width: 320px; } 
        }
        .side-menu ul li:hover {
            background-color: var(--light-gray);
        }
        /* Mejorar la visualización de la leyenda de Plotly en móvil */
        @media (max-width: 600px) {
            .stat-card .legend {
                max-width: 100%;
                overflow-x: auto;
                white-space: nowrap;
            }
        }
        .custom-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem 1.2rem;
            justify-content: center;
            margin: 0.5rem 0 0.2rem 0;
            font-size: 0.98rem;
            flex-direction: row;
            overflow-x: auto;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-right: 1.2rem;
            white-space: nowrap;
        }
        .legend-color {
            display: inline-block;
            width: 16px;
            height: 16px;
            border-radius: 3px;
            margin-right: 0.4em;
            border: 1px solid #ccc;
        }
        .bar-card {
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 1.5rem 1rem;
            margin-bottom: 2rem;
            border: 2px solid var(--light-gray);
        }
        .polygon-label {
            color: #222;
            font-size: 1.3rem;
            font-weight: bold;
            text-shadow: 1px 1px 2px #fff, 0 0 2px #fff;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <header class="header">
        <!-- Botón hamburguesa flotante -->
        <button id="menu-btn" class="menu-btn" aria-label="Abrir menú">
            <i class="fas fa-bars"></i>
            <span class="menu-btn-text">Menú</span>
        </button>
        <!-- Overlay antes del menú lateral -->
        <div id="menu-overlay" class="menu-overlay"></div>
        <!-- Menú lateral -->
        <nav id="side-menu" class="side-menu">
            <div class="side-menu-header">
                <!-- <span>Navegación</span> -->
                <!-- Botón de cerrar eliminado -->
            </div>
            <ul id="menu-options">
                <li><a href="/" class="active">Inicio</a></li>
                <li><a href="/san-bernardo"><i class="fas fa-map-marker-alt"></i> Barrio San Bernardo</a></li>
                <li><a href="/el-consuelo"><i class="fas fa-map-marker-alt"></i> Barrio El Consuelo</a></li>
            </ul>
        </nav>
        <div class="header-content">
            <h1><i class="fas fa-chart-line"></i> Indicadores de Gestión Localidad Santa Fe</h1>
            <p>Gestión de datos del barrio El Consuelo</p>
        </div>
    </header>

    <div class="container">
        <div class="controls">
            <div>
                <h2><i class="fas fa-dashboard"></i> Dashboard de Indicadores</h2>
                <p>Monitoreo de actividades y participación en el Barrio El Consuelo</p>
            </div>
            <button class="refresh-btn" onclick="loadData()">
                <i class="fas fa-sync-alt"></i>
                Actualizar Datos
            </button>
        </div>

        <!-- Indicador principal arriba del mapa -->
        <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); align-items: stretch;">
            <div class="stat-card" style="display: flex; flex-direction: column; justify-content: center; align-items: center;">
                <div class="icon"><i class="fas fa-poll"></i></div>
                <h3>{{ num_encuestas }}</h3>
                <p>Encuestas realizadas</p>
            </div>
        </div>

        <!-- Toggle para mostrar/ocultar puntos críticos -->
        <div style="text-align:center; margin-bottom: 1rem;">
            <label style="font-weight:600; font-size:1.1rem; margin-right:2em;">
                <input type="checkbox" id="toggle-puntos-criticos" style="margin-right:0.5em; transform: scale(1.3); vertical-align:middle;"> Mostrar puntos críticos en el mapa
            </label>
            <label style="font-weight:600; font-size:1.1rem;">
                <input type="checkbox" id="toggle-puntos-intervenidos" style="margin-right:0.5em; transform: scale(1.3); vertical-align:middle;"> Puntos críticos intervenidos
            </label>
        </div>

        <!-- Mapa de El Consuelo -->
        <div id="map" style="width: 100%; height: 500px; margin: 2rem 0; border-radius: 12px; box-shadow: var(--shadow);"></div>

        <!-- Título de información general -->
        <h2 style="margin-top: 1.5rem; margin-bottom: 1rem; text-align:center; color: var(--primary-red); font-size: 1.6rem; font-weight: 700;">Resultados generales de las encuestas</h2>

        <!-- Gráficas de torta debajo del mapa -->
        <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); align-items: stretch;">
            <div class="stat-card">
                <div class="chart-title" style="text-align:center; font-weight:600; margin-bottom:0.5rem;">Nivel educativo</div>
                <div id="nivelPie" style="height: 220px;"></div>
                <div class="custom-legend">
                    {% set colors = ['#fab62d', '#e4032e', '#4ECDC4', '#333333', '#96CEB4', '#BB8FCE'] %}
                    {% set labels = nivel_educativo_counts.keys()|list %}
                    {% for i in range(labels|length) %}
                        <span class="legend-item"><span class="legend-color" style="background:{{ colors[i % colors|length] }};"></span>{{ labels[i] }}</span>
                    {% endfor %}
                </div>
                <div style="text-align:center; font-weight:600; margin-top:0.5rem;"></div>
            </div>
            <div class="stat-card">
                <div class="chart-title" style="text-align:center; font-weight:600; margin-bottom:0.5rem;">Tiempo en el barrio</div>
                <div id="tiempoPie" style="height: 220px;"></div>
                <div class="custom-legend">
                    {% set colors = ['#fab62d', '#e4032e', '#4ECDC4', '#333333', '#96CEB4', '#BB8FCE'] %}
                    {% set labels = tiempo_reside_counts.keys()|list %}
                    {% for i in range(labels|length) %}
                        <span class="legend-item"><span class="legend-color" style="background:{{ colors[i % colors|length] }};"></span>{{ labels[i] }}</span>
                    {% endfor %}
                </div>
                <div style="text-align:center; font-weight:600; margin-top:0.5rem;"></div>
            </div>
        </div>

        <!-- Gráfica de barras para limpieza general -->
        <div class="stat-card" style="margin: 2rem auto; max-width: 800px;">
            <div id="limpiezaBar" style="height: 300px;"></div>
            <div style="text-align:center; font-weight:600; margin-top:0.5rem;">¿Cómo calificaría la limpieza general del barrio?</div>
        </div>
        
        <!-- Gráfica de barras para frecuencia de residuos -->
        <div class="stat-card" style="margin: 2rem auto; max-width: 800px;">
            <div id="residuosBar" style="height: 300px;"></div>
            <div style="text-align:center; font-weight:600; margin-top:0.5rem;">¿Con qué frecuencia observa residuos en las calles o zonas comunes?</div>
        </div>
        
        <!-- Gráfica de barras para afecta imagen del barrio -->
        <div class="stat-card" style="margin: 2rem auto; max-width: 800px;">
            <div id="tiempoBar" style="height: 300px;"></div>
            <div style="text-align:center; font-weight:600; margin-top:0.5rem;">¿Considera que la acumulación de residuos afecta la imagen del barrio?</div>
        </div>
        
        <!-- Gráfica de barras para residuos y seguridad -->
        <div class="stat-card" style="margin: 2rem auto; max-width: 800px;">
            <div id="seguridadBar" style="height: 300px;"></div>
            <div style="text-align:center; font-weight:600; margin-top:0.5rem;">¿Considera que el tema de residuos está relacionado con el tema de seguridad del barrio?</div>
        </div>
        
        <!-- Gráfica de barras para afecta calidad de vida -->
        <div class="stat-card" style="margin: 2rem auto; max-width: 800px;">
            <div id="calidadVidaBar" style="height: 300px;"></div>
            <div style="text-align:center; font-weight:600; margin-top:0.5rem;">¿Considera que la acumulación de residuos afecta su calidad de vida?</div>
        </div>
        
        <!-- Gráfica de barras para separación de residuos -->
        <div class="stat-card" style="margin: 2rem auto; max-width: 800px;">
            <div id="separacionBar" style="height: 300px;"></div>
            <div style="text-align:center; font-weight:600; margin-top:0.5rem;">¿Separa los residuos en su casa (orgánicos, reciclables, no reciclables)?</div>
        </div>
        
        <!-- Gráfica de barras para conoce horario recolección -->
        <div class="stat-card" style="margin: 2rem auto; max-width: 800px;">
            <div id="horarioBar" style="height: 300px;"></div>
            <div style="text-align:center; font-weight:600; margin-top:0.5rem;">¿Conoce el horario de recolección de residuos en el barrio?</div>
        </div>
        
        <!-- Gráfica de barras para saca residuos en horarios -->
        <div class="stat-card" style="margin: 2rem auto; max-width: 800px;">
            <div id="sacaHorariosBar" style="height: 300px;"></div>
            <div style="text-align:center; font-weight:600; margin-top:0.5rem;">¿Saca los residuos en los horarios establecidos?</div>
        </div>
        
        <!-- Gráfica de barras para entrega a recuperador -->
        <div class="stat-card" style="margin: 2rem auto; max-width: 800px;">
            <div id="recuperadorBar" style="height: 300px;"></div>
            <div style="text-align:center; font-weight:600; margin-top:0.5rem;">¿Entrega sus residuos aprovechables a un recuperador de oficio?</div>
        </div>
        
        <!-- Gráfica de barras para lugar de disposición -->
        <div class="stat-card" style="margin: 2rem auto; max-width: 800px;">
            <div id="lugarBar" style="height: 300px;"></div>
            <div style="text-align:center; font-weight:600; margin-top:0.5rem;">¿En qué lugar dispone los residuos?</div>
        </div>
        
        <!-- Gráfica de barras para calificación del servicio -->
        <div class="stat-card" style="margin: 2rem auto; max-width: 800px;">
            <div id="servicioBar" style="height: 300px;"></div>
            <div style="text-align:center; font-weight:600; margin-top:0.5rem;">¿Cómo calificaría la operación del servicio de aseo de Promoambiental Distrito S.A.S?</div>
        </div>
        
        <!-- Gráfica de barras para frecuencia camión recolector -->
        <div class="stat-card" style="margin: 2rem auto; max-width: 800px;">
            <div id="frecuenciaCamionBar" style="height: 300px;"></div>
            <div style="text-align:center; font-weight:600; margin-top:0.5rem;">¿Con qué frecuencia pasa el camión recolector de residuos?</div>
        </div>
        
        <!-- Gráfica de barras para participación en campañas -->
        <div class="stat-card" style="margin: 2rem auto; max-width: 800px;">
            <div id="participacionBar" style="height: 300px;"></div>
            <div style="text-align:center; font-weight:600; margin-top:0.5rem;">¿Ha participado en alguna campaña de limpieza o educación ambiental en su barrio?</div>
        </div>
        
        <!-- Gráfica de barras para iniciativas comunitarias -->
        <div class="stat-card" style="margin: 2rem auto; max-width: 800px;">
            <div id="iniciativasBar" style="height: 300px;"></div>
            <div style="text-align:center; font-weight:600; margin-top:0.5rem;">¿Le gustaría participar en iniciativas comunitarias de limpieza?</div>
        </div>
        
        <!-- Gráfica de barras para educación ambiental -->
        <div class="stat-card" style="margin: 2rem auto; max-width: 800px;">
            <div id="educacionBar" style="height: 300px;"></div>
            <div style="text-align:center; font-weight:600; margin-top:0.5rem;">¿Considera que hace falta más educación ambiental en el barrio?</div>
        </div>
        
        <!-- Gráfica de barras para sabe punto crítico -->
        <div class="stat-card" style="margin: 2rem auto; max-width: 800px;">
            <div id="puntoCriticoBar" style="height: 300px;"></div>
            <div style="text-align:center; font-weight:600; margin-top:0.5rem;">¿Sabe que es un punto crítico?</div>
        </div>
        
        <!-- Gráfica de barras para identifica puntos críticos -->
        <div class="stat-card" style="margin: 2rem auto; max-width: 800px;">
            <div id="identificaBar" style="height: 300px;"></div>
            <div style="text-align:center; font-weight:600; margin-top:0.5rem;">¿Identifica puntos críticos en el barrio?</div>
        </div>
        
        <!-- Gráfica de barras para tiempo puntos críticos -->
        <div class="stat-card" style="margin: 2rem auto; max-width: 800px;">
            <div id="tiempoPuntosBar" style="height: 300px;"></div>
            <div style="text-align:center; font-weight:600; margin-top:0.5rem;">¿Cada cuanto tiempo ve estos puntos en el barrio?</div>
        </div>
        


        <!-- Eliminado: Gráficas de barras categóricas y su JS asociado -->
        <!-- Fin de eliminación -->

        <div class="charts-grid">
            
        </div>
    </div>

    <script>
        function loadData() {
            // Simular carga de datos
            setTimeout(() => {
                // No hay estadísticas que actualizar
            }, 1000);
        }

        // Cargar datos al iniciar la página
        document.addEventListener('DOMContentLoaded', loadData);

        // Script robusto para menú hamburguesa flotante (idéntico al index)
        const menuBtn = document.getElementById('menu-btn');
        const sideMenu = document.getElementById('side-menu');
        const menuOverlay = document.getElementById('menu-overlay');
        function openMenu() {
            sideMenu.classList.add('open');
            menuOverlay.classList.add('open');
        }
        function closeMenu() {
            sideMenu.classList.remove('open');
            menuOverlay.classList.remove('open');
        }
        menuBtn.addEventListener('click', function() {
            if (sideMenu.classList.contains('open')) {
                closeMenu();
            } else {
                openMenu();
            }
        });
        menuOverlay.addEventListener('click', function() {
            closeMenu();
        });

        // Función para inicializar el menú lateral
        function initMenu() {
            const menuOptions = document.getElementById('menu-options');
            menuOptions.innerHTML = '';
            // Botón de Inicio
            const liInicio = document.createElement('li');
            liInicio.innerHTML = '<i class="fas fa-home"></i> Inicio';
            liInicio.addEventListener('click', () => {
                sideMenu.classList.remove('open');
                menuOverlay.classList.remove('open');
                window.location.href = '/';
            });
            menuOptions.appendChild(liInicio);
            // Botón Barrio San Bernardo
            const liSanBernardo = document.createElement('li');
            liSanBernardo.innerHTML = '<i class="fas fa-map-marker-alt"></i> Barrio San Bernardo';
            liSanBernardo.addEventListener('click', () => {
                sideMenu.classList.remove('open');
                menuOverlay.classList.remove('open');
                window.location.href = '/san-bernardo';
            });
            menuOptions.appendChild(liSanBernardo);
            // Botón Barrio El Consuelo
            const liElConsuelo = document.createElement('li');
            liElConsuelo.innerHTML = '<i class="fas fa-map-marker-alt"></i> Barrio El Consuelo';
            liElConsuelo.addEventListener('click', () => {
                sideMenu.classList.remove('open');
                menuOverlay.classList.remove('open');
                console.log('Ya estás en el Dashboard del Barrio El Consuelo');
            });
            menuOptions.appendChild(liElConsuelo);
            // Botón de Datos
            const liDatos = document.createElement('li');
            liDatos.innerHTML = '<i class="fas fa-database"></i> Datos';
            liDatos.addEventListener('click', () => {
                sideMenu.classList.remove('open');
                menuOverlay.classList.remove('open');
                window.location.href = '/datos';
            });
            menuOptions.appendChild(liDatos);
        }
        document.addEventListener('DOMContentLoaded', function() {
            initMenu();
            loadData();
        });

        // Inicializar el mapa centrado en Bogotá (ajusta si lo deseas)
        var map = L.map('map').setView([4.60971, -74.08175], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap'
        }).addTo(map);
        // Cargar el archivo KML de El Consuelo
        var kmlLayer = omnivore.kml('/static/data/ELCONSUELO.kml')
            .on('ready', function() {
                map.fitBounds(this.getBounds());
            })
            .addTo(map);
        // Variables para guardar los centros de los polígonos 6 y 19
        let center6 = null;
        let center19 = null;
        // Extraer y mostrar el número de cuadrante como label
        kmlLayer.on('layeradd', function(e) {
            if (e.layer.feature && e.layer.feature.properties && e.layer.feature.properties.description) {
                var desc = e.layer.feature.properties.description;
                var match = desc.match(/<td>\s*Número Cuadrante\s*<\/td>\s*<td>(\d+)<\/td>/);
                if (match && match[1]) {
                    var num = match[1];
                    var center = e.layer.getBounds().getCenter();
                    // Guardar los centros de los polígonos 6 y 19
                    if (num === '6') center6 = center;
                    if (num === '19') center19 = center;
                    // Ajuste personalizado para los números 5 y 18
                    if (num === '5' && center6) {
                        center = L.latLng(center6.lat - 0.0003, center6.lng); // Debajo del 6
                    } else if (num === '18' && center19) {
                        center = L.latLng(center19.lat, center19.lng + 0.0004); // Más a la derecha del 19
                    } else if (num === '18') {
                        center = L.latLng(4.58085, -74.0687); // Aproximado a 'calle 2 D Bis'
                    }
                    L.marker(center, {
                        icon: L.divIcon({
                            className: 'polygon-label',
                            html: '<b>' + num + '</b>',
                            iconSize: [30, 30]
                        })
                    }).addTo(map);
                }
            }
        });

        // --- Capa de puntos críticos (toggle) ---
        var puntosCriticosLayer = null;
        var puntosIntervenidosLayer = null;

        function crearMarcadorNumerado(latlng, numero, color) {
            var iconUrl = color === 'yellow'
                ? 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-yellow.png'
                : 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png';
            return L.marker(latlng, {
                icon: L.divIcon({
                    className: 'custom-marker-' + color,
                    html: '<div style="position:relative; width:30px; height:41px;">' +
                          '<img src="' + iconUrl + '" style="position:absolute; left:0; top:0; width:30px; height:41px;">' +
                          '<span style="position:absolute; top:7px; left:0; width:30px; text-align:center; color:black; font-weight:bold; font-size:16px; text-shadow:1px 1px 2px #fff;">' + numero + '</span>' +
                          '</div>',
                    iconSize: [30, 41],
                    iconAnchor: [15, 41],
                    popupAnchor: [1, -34],
                    shadowUrl: 'https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/images/marker-shadow.png',
                    shadowSize: [41, 41]
                })
            });
        }

        function cargarPuntosCriticos(callback, intervenidosSolo) {
            fetch('/static/data/Puntos_Criticos.kml')
                .then(response => response.text())
                .then(kmlText => {
                    var parser = new DOMParser();
                    var kml = parser.parseFromString(kmlText, 'text/xml');
                    var placemarks = kml.getElementsByTagName('Placemark');
                    var markers = [];
                    for (var i = 0; i < placemarks.length; i++) {
                        var coords = placemarks[i].getElementsByTagName('coordinates')[0].textContent.trim().split(',');
                        var lat = parseFloat(coords[1]);
                        var lng = parseFloat(coords[0]);
                        var color = (intervenidosSolo && i < 5) ? 'yellow' : (!intervenidosSolo ? 'red' : null);
                        if (color) {
                            markers.push(crearMarcadorNumerado([lat, lng], i + 1, color));
                        }
                    }
                    callback(markers);
                });
        }

        document.getElementById('toggle-puntos-criticos').addEventListener('change', function(e) {
            if (e.target.checked) {
                if (!puntosCriticosLayer) {
                    cargarPuntosCriticos(function(markers) {
                        puntosCriticosLayer = L.layerGroup(markers);
                        puntosCriticosLayer.addTo(map);
                    }, false);
                } else {
                    puntosCriticosLayer.addTo(map);
                }
            } else {
                if (puntosCriticosLayer) {
                    map.removeLayer(puntosCriticosLayer);
                }
            }
        });

        document.getElementById('toggle-puntos-intervenidos').addEventListener('change', function(e) {
            if (e.target.checked) {
                if (!puntosIntervenidosLayer) {
                    cargarPuntosCriticos(function(markers) {
                        puntosIntervenidosLayer = L.layerGroup(markers);
                        puntosIntervenidosLayer.addTo(map);
                    }, true);
                } else {
                    puntosIntervenidosLayer.addTo(map);
                }
            } else {
                if (puntosIntervenidosLayer) {
                    map.removeLayer(puntosIntervenidosLayer);
                }
            }
        });

        // Graficas de torta con Plotly
        window.addEventListener('DOMContentLoaded', function() {
            // Nivel educativo
            var nivelLabels = {{ nivel_educativo_counts.keys()|list|tojson }};
            var nivelValues = {{ nivel_educativo_counts.values()|list|tojson }};
            Plotly.newPlot('nivelPie', [{
                values: nivelValues,
                labels: nivelLabels,
                type: 'pie',
                marker: {colors: ['#fab62d', '#e4032e', '#4ECDC4', '#333333', '#96CEB4', '#BB8FCE']},
                textinfo: 'percent',
                insidetextorientation: 'radial'
            }], {
                margin: {t: 0, b: 0, l: 0, r: 0},
                showlegend: false,
                height: 320
            }, {responsive: true});

            // Tiempo de residencia
            var tiempoLabels = {{ tiempo_reside_counts.keys()|list|tojson }};
            var tiempoValues = {{ tiempo_reside_counts.values()|list|tojson }};
            Plotly.newPlot('tiempoPie', [{
                values: tiempoValues,
                labels: tiempoLabels,
                type: 'pie',
                marker: {colors: ['#fab62d', '#e4032e', '#4ECDC4', '#333333', '#96CEB4', '#BB8FCE']},
                textinfo: 'percent',
                insidetextorientation: 'radial'
            }], {
                margin: {t: 0, b: 0, l: 0, r: 0},
                showlegend: false,
                height: 320
            }, {responsive: true});

            // Gráfica de barras de limpieza
            var limpiezaLabels = Object.keys({{ limpieza_counts|tojson }});
            var limpiezaValues = Object.values({{ limpieza_counts|tojson }});
            var limpiezaColors = ['#fab62d', '#e4032e', '#4ECDC4', '#333333', '#96CEB4'];
            
            // Ordenar los datos por valor (de mayor a menor)
            var sortedData = limpiezaLabels.map(function(label, index) {
                return {
                    label: label,
                    value: limpiezaValues[index],
                    color: limpiezaColors[index % limpiezaColors.length]
                };
            }).sort(function(a, b) {
                return b.value - a.value;
            });
            
            var sortedLabels = sortedData.map(function(item) { return item.label; });
            var sortedValues = sortedData.map(function(item) { return item.value; });
            var sortedColors = sortedData.map(function(item) { return item.color; });
            
            Plotly.newPlot('limpiezaBar', [{
                x: sortedValues,
                y: sortedLabels,
                type: 'bar',
                orientation: 'h',
                marker: {
                    color: sortedColors,
                    line: {
                        color: '#333333',
                        width: 1
                    }
                },
                text: sortedValues.map(String),
                textposition: 'auto',
                textfont: {
                    size: 14,
                    color: '#333333'
                },
                hoverinfo: 'x+y',
                hoverlabel: {
                    bgcolor: '#ffffff',
                    bordercolor: '#333333',
                    font: {size: 14}
                }
            }], {
                margin: {l: 80, r: 50, t: 30, b: 50},
                height: 300,
                showlegend: false,
                xaxis: {
                    title: 'Número de respuestas',
                    titlefont: {size: 14, color: '#333333'},
                    tickfont: {size: 12, color: '#333333'},
                    gridcolor: '#e0e0e0',
                    zeroline: false
                },
                yaxis: {
                    title: 'Calificación',
                    titlefont: {size: 14, color: '#333333'},
                    tickfont: {size: 12, color: '#333333'},
                    gridcolor: '#e0e0e0'
                },
                plot_bgcolor: '#ffffff',
                paper_bgcolor: '#ffffff'
            }, {responsive: true});
            
            // Gráfica de barras de frecuencia de residuos
            var residuosLabels = Object.keys({{ residuos_counts|tojson }});
            var residuosValues = Object.values({{ residuos_counts|tojson }});
            var residuosColors = ['#fab62d', '#e4032e', '#4ECDC4', '#333333', '#96CEB4', '#BB8FCE'];
            
            // Ordenar los datos por valor (de mayor a menor)
            var sortedResiduosData = residuosLabels.map(function(label, index) {
                return {
                    label: label,
                    value: residuosValues[index],
                    color: residuosColors[index % residuosColors.length]
                };
            }).sort(function(a, b) {
                return b.value - a.value;
            });
            
            var sortedResiduosLabels = sortedResiduosData.map(function(item) { return item.label; });
            var sortedResiduosValues = sortedResiduosData.map(function(item) { return item.value; });
            var sortedResiduosColors = sortedResiduosData.map(function(item) { return item.color; });
            
            Plotly.newPlot('residuosBar', [{
                x: sortedResiduosValues,
                y: sortedResiduosLabels,
                type: 'bar',
                orientation: 'h',
                marker: {
                    color: sortedResiduosColors,
                    line: {
                        color: '#333333',
                        width: 1
                    }
                },
                text: sortedResiduosValues.map(String),
                textposition: 'auto',
                textfont: {
                    size: 14,
                    color: '#333333'
                },
                hoverinfo: 'x+y',
                hoverlabel: {
                    bgcolor: '#ffffff',
                    bordercolor: '#333333',
                    font: {size: 14}
                }
            }], {
                margin: {l: 150, r: 50, t: 30, b: 50},
                height: 300,
                showlegend: false,
                xaxis: {
                    title: 'Número de respuestas',
                    titlefont: {size: 14, color: '#333333'},
                    tickfont: {size: 12, color: '#333333'},
                    gridcolor: '#e0e0e0',
                    zeroline: false
                },
                yaxis: {
                    title: 'Frecuencia',
                    titlefont: {size: 14, color: '#333333'},
                    tickfont: {size: 12, color: '#333333'},
                    gridcolor: '#e0e0e0'
                },
                plot_bgcolor: '#ffffff',
                paper_bgcolor: '#ffffff'
            }, {responsive: true});
            
            // Gráfica de barras de tiempo de residencia
            var tiempoLabels = Object.keys({{ tiempo_counts|tojson }});
            var tiempoValues = Object.values({{ tiempo_counts|tojson }});
            var tiempoColors = ['#fab62d', '#e4032e', '#4ECDC4', '#333333', '#96CEB4', '#BB8FCE'];
            
            // Ordenar los datos por valor (de mayor a menor)
            var sortedTiempoData = tiempoLabels.map(function(label, index) {
                return {
                    label: label,
                    value: tiempoValues[index],
                    color: tiempoColors[index % tiempoColors.length]
                };
            }).sort(function(a, b) {
                return b.value - a.value;
            });
            
            var sortedTiempoLabels = sortedTiempoData.map(function(item) { return item.label; });
            var sortedTiempoValues = sortedTiempoData.map(function(item) { return item.value; });
            var sortedTiempoColors = sortedTiempoData.map(function(item) { return item.color; });
            
            Plotly.newPlot('tiempoBar', [{
                x: sortedTiempoValues,
                y: sortedTiempoLabels,
                type: 'bar',
                orientation: 'h',
                marker: {
                    color: sortedTiempoColors,
                    line: {
                        color: '#333333',
                        width: 1
                    }
                },
                text: sortedTiempoValues.map(String),
                textposition: 'auto',
                textfont: {
                    size: 14,
                    color: '#333333'
                },
                hoverinfo: 'x+y',
                hoverlabel: {
                    bgcolor: '#ffffff',
                    bordercolor: '#333333',
                    font: {size: 14}
                }
            }], {
                margin: {l: 150, r: 50, t: 30, b: 50},
                height: 300,
                showlegend: false,
                xaxis: {
                    title: 'Número de respuestas',
                    titlefont: {size: 14, color: '#333333'},
                    tickfont: {size: 12, color: '#333333'},
                    gridcolor: '#e0e0e0',
                    zeroline: false
                },
                yaxis: {
                    title: 'Respuesta',
                    titlefont: {size: 14, color: '#333333'},
                    tickfont: {size: 12, color: '#333333'},
                    gridcolor: '#e0e0e0'
                },
                plot_bgcolor: '#ffffff',
                paper_bgcolor: '#ffffff'
            }, {responsive: true});
            
            // Gráfica de barras de residuos y seguridad
            var seguridadLabels = Object.keys({{ seguridad_counts|tojson }});
            var seguridadValues = Object.values({{ seguridad_counts|tojson }});
            var seguridadColors = ['#fab62d', '#e4032e', '#4ECDC4', '#333333', '#96CEB4', '#BB8FCE'];
            
            // Ordenar los datos por valor (de mayor a menor)
            var sortedSeguridadData = seguridadLabels.map(function(label, index) {
                return {
                    label: label,
                    value: seguridadValues[index],
                    color: seguridadColors[index % seguridadColors.length]
                };
            }).sort(function(a, b) {
                return b.value - a.value;
            });
            
            var sortedSeguridadLabels = sortedSeguridadData.map(function(item) { return item.label; });
            var sortedSeguridadValues = sortedSeguridadData.map(function(item) { return item.value; });
            var sortedSeguridadColors = sortedSeguridadData.map(function(item) { return item.color; });
            
            Plotly.newPlot('seguridadBar', [{
                x: sortedSeguridadValues,
                y: sortedSeguridadLabels,
                type: 'bar',
                orientation: 'h',
                marker: {
                    color: sortedSeguridadColors,
                    line: {
                        color: '#333333',
                        width: 1
                    }
                },
                text: sortedSeguridadValues.map(String),
                textposition: 'auto',
                textfont: {
                    size: 14,
                    color: '#333333'
                },
                hoverinfo: 'x+y',
                hoverlabel: {
                    bgcolor: '#ffffff',
                    bordercolor: '#333333',
                    font: {size: 14}
                }
            }], {
                margin: {l: 200, r: 50, t: 30, b: 50},
                height: 300,
                showlegend: false,
                xaxis: {
                    title: 'Número de respuestas',
                    titlefont: {size: 14, color: '#333333'},
                    tickfont: {size: 12, color: '#333333'},
                    gridcolor: '#e0e0e0',
                    zeroline: false
                },
                yaxis: {
                    title: 'Respuesta',
                    titlefont: {size: 14, color: '#333333'},
                    tickfont: {size: 12, color: '#333333'},
                    gridcolor: '#e0e0e0'
                },
                plot_bgcolor: '#ffffff',
                paper_bgcolor: '#ffffff'
            }, {responsive: true});
            
            // Gráfica de barras de calidad de vida
            var calidadVidaLabels = Object.keys({{ calidad_vida_counts|tojson }});
            var calidadVidaValues = Object.values({{ calidad_vida_counts|tojson }});
            var calidadVidaColors = ['#fab62d', '#e4032e', '#4ECDC4', '#333333', '#96CEB4', '#BB8FCE'];
            
            // Ordenar los datos por valor (de mayor a menor)
            var sortedCalidadVidaData = calidadVidaLabels.map(function(label, index) {
                return {
                    label: label,
                    value: calidadVidaValues[index],
                    color: calidadVidaColors[index % calidadVidaColors.length]
                };
            }).sort(function(a, b) {
                return b.value - a.value;
            });
            
            var sortedCalidadVidaLabels = sortedCalidadVidaData.map(function(item) { return item.label; });
            var sortedCalidadVidaValues = sortedCalidadVidaData.map(function(item) { return item.value; });
            var sortedCalidadVidaColors = sortedCalidadVidaData.map(function(item) { return item.color; });
            
            Plotly.newPlot('calidadVidaBar', [{
                x: sortedCalidadVidaValues,
                y: sortedCalidadVidaLabels,
                type: 'bar',
                orientation: 'h',
                marker: {
                    color: sortedCalidadVidaColors,
                    line: {
                        color: '#333333',
                        width: 1
                    }
                },
                text: sortedCalidadVidaValues.map(String),
                textposition: 'auto',
                textfont: {
                    size: 14,
                    color: '#333333'
                },
                hoverinfo: 'x+y',
                hoverlabel: {
                    bgcolor: '#ffffff',
                    bordercolor: '#333333',
                    font: {size: 14}
                }
            }], {
                margin: {l: 200, r: 50, t: 30, b: 50},
                height: 300,
                showlegend: false,
                xaxis: {
                    title: 'Número de respuestas',
                    titlefont: {size: 14, color: '#333333'},
                    tickfont: {size: 12, color: '#333333'},
                    gridcolor: '#e0e0e0',
                    zeroline: false
                },
                yaxis: {
                    title: 'Respuesta',
                    titlefont: {size: 14, color: '#333333'},
                    tickfont: {size: 12, color: '#333333'},
                    gridcolor: '#e0e0e0'
                },
                plot_bgcolor: '#ffffff',
                paper_bgcolor: '#ffffff'
            }, {responsive: true});
            
            // Gráfica de barras de separación de residuos
            var separacionLabels = Object.keys({{ separacion_counts|tojson }});
            var separacionValues = Object.values({{ separacion_counts|tojson }});
            var separacionColors = ['#fab62d', '#e4032e', '#4ECDC4', '#333333', '#96CEB4', '#BB8FCE'];
            
            // Ordenar los datos por valor (de mayor a menor)
            var sortedSeparacionData = separacionLabels.map(function(label, index) {
                return {
                    label: label,
                    value: separacionValues[index],
                    color: separacionColors[index % separacionColors.length]
                };
            }).sort(function(a, b) {
                return b.value - a.value;
            });
            
            var sortedSeparacionLabels = sortedSeparacionData.map(function(item) { return item.label; });
            var sortedSeparacionValues = sortedSeparacionData.map(function(item) { return item.value; });
            var sortedSeparacionColors = sortedSeparacionData.map(function(item) { return item.color; });
            
            Plotly.newPlot('separacionBar', [{
                x: sortedSeparacionValues,
                y: sortedSeparacionLabels,
                type: 'bar',
                orientation: 'h',
                marker: {
                    color: sortedSeparacionColors,
                    line: {
                        color: '#333333',
                        width: 1
                    }
                },
                text: sortedSeparacionValues.map(String),
                textposition: 'auto',
                textfont: {
                    size: 14,
                    color: '#333333'
                },
                hoverinfo: 'x+y',
                hoverlabel: {
                    bgcolor: '#ffffff',
                    bordercolor: '#333333',
                    font: {size: 14}
                }
            }], {
                margin: {l: 200, r: 50, t: 30, b: 50},
                height: 300,
                showlegend: false,
                xaxis: {
                    title: 'Número de respuestas',
                    titlefont: {size: 14, color: '#333333'},
                    tickfont: {size: 12, color: '#333333'},
                    gridcolor: '#e0e0e0',
                    zeroline: false
                },
                yaxis: {
                    title: 'Respuesta',
                    titlefont: {size: 14, color: '#333333'},
                    tickfont: {size: 12, color: '#333333'},
                    gridcolor: '#e0e0e0'
                },
                plot_bgcolor: '#ffffff',
                paper_bgcolor: '#ffffff'
            }, {responsive: true});
            
            // Gráfica de barras de conoce horario recolección
            var horarioLabels = Object.keys({{ horario_counts|tojson }});
            var horarioValues = Object.values({{ horario_counts|tojson }});
            var horarioColors = ['#fab62d', '#e4032e', '#4ECDC4', '#333333', '#96CEB4', '#BB8FCE'];
            
            // Ordenar los datos por valor (de mayor a menor)
            var sortedHorarioData = horarioLabels.map(function(label, index) {
                return {
                    label: label,
                    value: horarioValues[index],
                    color: horarioColors[index % horarioColors.length]
                };
            }).sort(function(a, b) {
                return b.value - a.value;
            });
            
            var sortedHorarioLabels = sortedHorarioData.map(function(item) { return item.label; });
            var sortedHorarioValues = sortedHorarioData.map(function(item) { return item.value; });
            var sortedHorarioColors = sortedHorarioData.map(function(item) { return item.color; });
            
            Plotly.newPlot('horarioBar', [{
                x: sortedHorarioValues,
                y: sortedHorarioLabels,
                type: 'bar',
                orientation: 'h',
                marker: {
                    color: sortedHorarioColors,
                    line: {
                        color: '#333333',
                        width: 1
                    }
                },
                text: sortedHorarioValues.map(String),
                textposition: 'auto',
                textfont: {
                    size: 14,
                    color: '#333333'
                },
                hoverinfo: 'x+y',
                hoverlabel: {
                    bgcolor: '#ffffff',
                    bordercolor: '#333333',
                    font: {size: 14}
                }
            }], {
                margin: {l: 200, r: 50, t: 30, b: 50},
                height: 300,
                showlegend: false,
                xaxis: {
                    title: 'Número de respuestas',
                    titlefont: {size: 14, color: '#333333'},
                    tickfont: {size: 12, color: '#333333'},
                    gridcolor: '#e0e0e0',
                    zeroline: false
                },
                yaxis: {
                    title: 'Respuesta',
                    titlefont: {size: 14, color: '#333333'},
                    tickfont: {size: 12, color: '#333333'},
                    gridcolor: '#e0e0e0'
                },
                plot_bgcolor: '#ffffff',
                paper_bgcolor: '#ffffff'
            }, {responsive: true});
            
            // Gráfica de barras de saca residuos en horarios
            var sacaHorariosLabels = Object.keys({{ saca_horarios_counts|tojson }});
            var sacaHorariosValues = Object.values({{ saca_horarios_counts|tojson }});
            var sacaHorariosColors = ['#fab62d', '#e4032e', '#4ECDC4', '#333333', '#96CEB4', '#BB8FCE'];
            
            // Ordenar los datos por valor (de mayor a menor)
            var sortedSacaHorariosData = sacaHorariosLabels.map(function(label, index) {
                return {
                    label: label,
                    value: sacaHorariosValues[index],
                    color: sacaHorariosColors[index % sacaHorariosColors.length]
                };
            }).sort(function(a, b) {
                return b.value - a.value;
            });
            
            var sortedSacaHorariosLabels = sortedSacaHorariosData.map(function(item) { return item.label; });
            var sortedSacaHorariosValues = sortedSacaHorariosData.map(function(item) { return item.value; });
            var sortedSacaHorariosColors = sortedSacaHorariosData.map(function(item) { return item.color; });
            
            Plotly.newPlot('sacaHorariosBar', [{
                x: sortedSacaHorariosValues,
                y: sortedSacaHorariosLabels,
                type: 'bar',
                orientation: 'h',
                marker: {
                    color: sortedSacaHorariosColors,
                    line: {
                        color: '#333333',
                        width: 1
                    }
                },
                text: sortedSacaHorariosValues.map(String),
                textposition: 'auto',
                textfont: {
                    size: 14,
                    color: '#333333'
                },
                hoverinfo: 'x+y',
                hoverlabel: {
                    bgcolor: '#ffffff',
                    bordercolor: '#333333',
                    font: {size: 14}
                }
            }], {
                margin: {l: 200, r: 50, t: 30, b: 50},
                height: 300,
                showlegend: false,
                xaxis: {
                    title: 'Número de respuestas',
                    titlefont: {size: 14, color: '#333333'},
                    tickfont: {size: 12, color: '#333333'},
                    gridcolor: '#e0e0e0',
                    zeroline: false
                },
                yaxis: {
                    title: 'Respuesta',
                    titlefont: {size: 14, color: '#333333'},
                    tickfont: {size: 12, color: '#333333'},
                    gridcolor: '#e0e0e0'
                },
                plot_bgcolor: '#ffffff',
                paper_bgcolor: '#ffffff'
            }, {responsive: true});
            
            // Gráfica de barras de entrega a recuperador
            var recuperadorLabels = Object.keys({{ recuperador_counts|tojson }});
            var recuperadorValues = Object.values({{ recuperador_counts|tojson }});
            var recuperadorColors = ['#fab62d', '#e4032e', '#4ECDC4', '#333333', '#96CEB4', '#BB8FCE'];
            
            // Ordenar los datos por valor (de mayor a menor)
            var sortedRecuperadorData = recuperadorLabels.map(function(label, index) {
                return {
                    label: label,
                    value: recuperadorValues[index],
                    color: recuperadorColors[index % recuperadorColors.length]
                };
            }).sort(function(a, b) {
                return b.value - a.value;
            });
            
            var sortedRecuperadorLabels = sortedRecuperadorData.map(function(item) { return item.label; });
            var sortedRecuperadorValues = sortedRecuperadorData.map(function(item) { return item.value; });
            var sortedRecuperadorColors = sortedRecuperadorData.map(function(item) { return item.color; });
            
            var recuperadorTrace = {
                x: sortedRecuperadorValues,
                y: sortedRecuperadorLabels,
                type: 'bar',
                orientation: 'h',
                marker: {
                    color: sortedRecuperadorColors
                }
            };
            
            var recuperadorLayout = {
                margin: {l: 150, r: 50, t: 50, b: 50},
                xaxis: {title: 'Cantidad de respuestas'},
                yaxis: {title: ''}
            };
            
            Plotly.newPlot('recuperadorBar', [recuperadorTrace], recuperadorLayout, {responsive: true});
            
            // Gráfica de barras de lugar de disposición
            var lugarLabels = Object.keys({{ lugar_counts|tojson }});
            var lugarValues = Object.values({{ lugar_counts|tojson }});
            var lugarColors = ['#fab62d', '#e4032e', '#4ECDC4', '#333333', '#96CEB4', '#BB8FCE'];
            
            // Ordenar los datos por valor (de mayor a menor)
            var sortedLugarData = lugarLabels.map(function(label, index) {
                return {
                    label: label,
                    value: lugarValues[index],
                    color: lugarColors[index % lugarColors.length]
                };
            }).sort(function(a, b) {
                return b.value - a.value;
            });
            
            var sortedLugarLabels = sortedLugarData.map(function(item) { return item.label; });
            var sortedLugarValues = sortedLugarData.map(function(item) { return item.value; });
            var sortedLugarColors = sortedLugarData.map(function(item) { return item.color; });
            
            var lugarTrace = {
                x: sortedLugarValues,
                y: sortedLugarLabels,
                type: 'bar',
                orientation: 'h',
                marker: {
                    color: sortedLugarColors
                }
            };
            
            var lugarLayout = {
                margin: {l: 150, r: 50, t: 50, b: 50},
                xaxis: {title: 'Cantidad de respuestas'},
                yaxis: {title: ''}
            };
            
            Plotly.newPlot('lugarBar', [lugarTrace], lugarLayout, {responsive: true});
            
            // Gráfica de barras de calificación del servicio
            var servicioLabels = Object.keys({{ servicio_counts|tojson }});
            var servicioValues = Object.values({{ servicio_counts|tojson }});
            var servicioColors = ['#fab62d', '#e4032e', '#4ECDC4', '#333333', '#96CEB4', '#BB8FCE'];
            
            // Ordenar los datos por valor (de mayor a menor)
            var sortedServicioData = servicioLabels.map(function(label, index) {
                return {
                    label: label,
                    value: servicioValues[index],
                    color: servicioColors[index % servicioColors.length]
                };
            }).sort(function(a, b) {
                return b.value - a.value;
            });
            
            var sortedServicioLabels = sortedServicioData.map(function(item) { return item.label; });
            var sortedServicioValues = sortedServicioData.map(function(item) { return item.value; });
            var sortedServicioColors = sortedServicioData.map(function(item) { return item.color; });
            
            var servicioTrace = {
                x: sortedServicioValues,
                y: sortedServicioLabels,
                type: 'bar',
                orientation: 'h',
                marker: {
                    color: sortedServicioColors
                }
            };
            
            var servicioLayout = {
                margin: {l: 150, r: 50, t: 50, b: 50},
                xaxis: {title: 'Cantidad de respuestas'},
                yaxis: {title: ''}
            };
            
            Plotly.newPlot('servicioBar', [servicioTrace], servicioLayout, {responsive: true});
            
            // Gráfica de barras de frecuencia camión recolector
            var frecuenciaCamionLabels = Object.keys({{ frecuencia_camion_counts|tojson }});
            var frecuenciaCamionValues = Object.values({{ frecuencia_camion_counts|tojson }});
            var frecuenciaCamionColors = ['#fab62d', '#e4032e', '#4ECDC4', '#333333', '#96CEB4', '#BB8FCE'];
            
            // Ordenar los datos por valor (de mayor a menor)
            var sortedFrecuenciaCamionData = frecuenciaCamionLabels.map(function(label, index) {
                return {
                    label: label,
                    value: frecuenciaCamionValues[index],
                    color: frecuenciaCamionColors[index % frecuenciaCamionColors.length]
                };
            }).sort(function(a, b) {
                return b.value - a.value;
            });
            
            var sortedFrecuenciaCamionLabels = sortedFrecuenciaCamionData.map(function(item) { return item.label; });
            var sortedFrecuenciaCamionValues = sortedFrecuenciaCamionData.map(function(item) { return item.value; });
            var sortedFrecuenciaCamionColors = sortedFrecuenciaCamionData.map(function(item) { return item.color; });
            
            var frecuenciaCamionTrace = {
                x: sortedFrecuenciaCamionValues,
                y: sortedFrecuenciaCamionLabels,
                type: 'bar',
                orientation: 'h',
                marker: {
                    color: sortedFrecuenciaCamionColors
                }
            };
            
            var frecuenciaCamionLayout = {
                margin: {l: 150, r: 50, t: 50, b: 50},
                xaxis: {title: 'Cantidad de respuestas'},
                yaxis: {title: ''}
            };
            
            Plotly.newPlot('frecuenciaCamionBar', [frecuenciaCamionTrace], frecuenciaCamionLayout, {responsive: true});
            
            // Gráfica de barras de participación en campañas
            var participacionLabels = Object.keys({{ participacion_counts|tojson }});
            var participacionValues = Object.values({{ participacion_counts|tojson }});
            var participacionColors = ['#fab62d', '#e4032e', '#4ECDC4', '#333333', '#96CEB4', '#BB8FCE'];
            
            // Ordenar los datos por valor (de mayor a menor)
            var sortedParticipacionData = participacionLabels.map(function(label, index) {
                return {
                    label: label,
                    value: participacionValues[index],
                    color: participacionColors[index % participacionColors.length]
                };
            }).sort(function(a, b) {
                return b.value - a.value;
            });
            
            var sortedParticipacionLabels = sortedParticipacionData.map(function(item) { return item.label; });
            var sortedParticipacionValues = sortedParticipacionData.map(function(item) { return item.value; });
            var sortedParticipacionColors = sortedParticipacionData.map(function(item) { return item.color; });
            
            var participacionTrace = {
                x: sortedParticipacionValues,
                y: sortedParticipacionLabels,
                type: 'bar',
                orientation: 'h',
                marker: {
                    color: sortedParticipacionColors
                }
            };
            
            var participacionLayout = {
                margin: {l: 150, r: 50, t: 50, b: 50},
                xaxis: {title: 'Cantidad de respuestas'},
                yaxis: {title: ''}
            };
            
            Plotly.newPlot('participacionBar', [participacionTrace], participacionLayout, {responsive: true});
            
            // Gráfica de barras de iniciativas comunitarias
            var iniciativasLabels = Object.keys({{ iniciativas_counts|tojson }});
            var iniciativasValues = Object.values({{ iniciativas_counts|tojson }});
            var iniciativasColors = ['#fab62d', '#e4032e', '#4ECDC4', '#333333', '#96CEB4', '#BB8FCE'];
            
            // Ordenar los datos por valor (de mayor a menor)
            var sortedIniciativasData = iniciativasLabels.map(function(label, index) {
                return {
                    label: label,
                    value: iniciativasValues[index],
                    color: iniciativasColors[index % iniciativasColors.length]
                };
            }).sort(function(a, b) {
                return b.value - a.value;
            });
            
            var sortedIniciativasLabels = sortedIniciativasData.map(function(item) { return item.label; });
            var sortedIniciativasValues = sortedIniciativasData.map(function(item) { return item.value; });
            var sortedIniciativasColors = sortedIniciativasData.map(function(item) { return item.color; });
            
            var iniciativasTrace = {
                x: sortedIniciativasValues,
                y: sortedIniciativasLabels,
                type: 'bar',
                orientation: 'h',
                marker: {
                    color: sortedIniciativasColors
                }
            };
            
            var iniciativasLayout = {
                margin: {l: 150, r: 50, t: 50, b: 50},
                xaxis: {title: 'Cantidad de respuestas'},
                yaxis: {title: ''}
            };
            
            Plotly.newPlot('iniciativasBar', [iniciativasTrace], iniciativasLayout, {responsive: true});
            
            // Gráfica de barras de educación ambiental
            var educacionLabels = Object.keys({{ educacion_counts|tojson }});
            var educacionValues = Object.values({{ educacion_counts|tojson }});
            var educacionColors = ['#fab62d', '#e4032e', '#4ECDC4', '#333333', '#96CEB4', '#BB8FCE'];
            
            // Ordenar los datos por valor (de mayor a menor)
            var sortedEducacionData = educacionLabels.map(function(label, index) {
                return {
                    label: label,
                    value: educacionValues[index],
                    color: educacionColors[index % educacionColors.length]
                };
            }).sort(function(a, b) {
                return b.value - a.value;
            });
            
            var sortedEducacionLabels = sortedEducacionData.map(function(item) { return item.label; });
            var sortedEducacionValues = sortedEducacionData.map(function(item) { return item.value; });
            var sortedEducacionColors = sortedEducacionData.map(function(item) { return item.color; });
            
            var educacionTrace = {
                x: sortedEducacionValues,
                y: sortedEducacionLabels,
                type: 'bar',
                orientation: 'h',
                marker: {
                    color: sortedEducacionColors
                }
            };
            
            var educacionLayout = {
                margin: {l: 150, r: 50, t: 50, b: 50},
                xaxis: {title: 'Cantidad de respuestas'},
                yaxis: {title: ''}
            };
            
            Plotly.newPlot('educacionBar', [educacionTrace], educacionLayout, {responsive: true});
            
            // Gráfica de barras de sabe punto crítico
            var puntoCriticoLabels = Object.keys({{ punto_critico_counts|tojson }});
            var puntoCriticoValues = Object.values({{ punto_critico_counts|tojson }});
            var puntoCriticoColors = ['#fab62d', '#e4032e', '#4ECDC4', '#333333', '#96CEB4', '#BB8FCE'];
            
            // Ordenar los datos por valor (de mayor a menor)
            var sortedPuntoCriticoData = puntoCriticoLabels.map(function(label, index) {
                return {
                    label: label,
                    value: puntoCriticoValues[index],
                    color: puntoCriticoColors[index % puntoCriticoColors.length]
                };
            }).sort(function(a, b) {
                return b.value - a.value;
            });
            
            var sortedPuntoCriticoLabels = sortedPuntoCriticoData.map(function(item) { return item.label; });
            var sortedPuntoCriticoValues = sortedPuntoCriticoData.map(function(item) { return item.value; });
            var sortedPuntoCriticoColors = sortedPuntoCriticoData.map(function(item) { return item.color; });
            
            var puntoCriticoTrace = {
                x: sortedPuntoCriticoValues,
                y: sortedPuntoCriticoLabels,
                type: 'bar',
                orientation: 'h',
                marker: {
                    color: sortedPuntoCriticoColors
                }
            };
            
            var puntoCriticoLayout = {
                margin: {l: 150, r: 50, t: 50, b: 50},
                xaxis: {title: 'Cantidad de respuestas'},
                yaxis: {title: ''}
            };
            
            Plotly.newPlot('puntoCriticoBar', [puntoCriticoTrace], puntoCriticoLayout, {responsive: true});
            
            // Gráfica de barras de identifica puntos críticos
            var identificaLabels = Object.keys({{ identifica_counts|tojson }});
            var identificaValues = Object.values({{ identifica_counts|tojson }});
            var identificaColors = ['#fab62d', '#e4032e', '#4ECDC4', '#333333', '#96CEB4', '#BB8FCE'];
            
            // Ordenar los datos por valor (de mayor a menor)
            var sortedIdentificaData = identificaLabels.map(function(label, index) {
                return {
                    label: label,
                    value: identificaValues[index],
                    color: identificaColors[index % identificaColors.length]
                };
            }).sort(function(a, b) {
                return b.value - a.value;
            });
            
            var sortedIdentificaLabels = sortedIdentificaData.map(function(item) { return item.label; });
            var sortedIdentificaValues = sortedIdentificaData.map(function(item) { return item.value; });
            var sortedIdentificaColors = sortedIdentificaData.map(function(item) { return item.color; });
            
            var identificaTrace = {
                x: sortedIdentificaValues,
                y: sortedIdentificaLabels,
                type: 'bar',
                orientation: 'h',
                marker: {
                    color: sortedIdentificaColors
                }
            };
            
            var identificaLayout = {
                margin: {l: 150, r: 50, t: 50, b: 50},
                xaxis: {title: 'Cantidad de respuestas'},
                yaxis: {title: ''}
            };
            
            Plotly.newPlot('identificaBar', [identificaTrace], identificaLayout, {responsive: true});
            
            // Gráfica de barras de tiempo puntos críticos
            var tiempoPuntosLabels = Object.keys({{ tiempo_puntos_counts|tojson }});
            var tiempoPuntosValues = Object.values({{ tiempo_puntos_counts|tojson }});
            var tiempoPuntosColors = ['#fab62d', '#e4032e', '#4ECDC4', '#333333', '#96CEB4', '#BB8FCE'];
            
            // Ordenar los datos por valor (de mayor a menor)
            var sortedTiempoPuntosData = tiempoPuntosLabels.map(function(label, index) {
                return {
                    label: label,
                    value: tiempoPuntosValues[index],
                    color: tiempoPuntosColors[index % tiempoPuntosColors.length]
                };
            }).sort(function(a, b) {
                return b.value - a.value;
            });
            
            var sortedTiempoPuntosLabels = sortedTiempoPuntosData.map(function(item) { return item.label; });
            var sortedTiempoPuntosValues = sortedTiempoPuntosData.map(function(item) { return item.value; });
            var sortedTiempoPuntosColors = sortedTiempoPuntosData.map(function(item) { return item.color; });
            
            var tiempoPuntosTrace = {
                x: sortedTiempoPuntosValues,
                y: sortedTiempoPuntosLabels,
                type: 'bar',
                orientation: 'h',
                marker: {
                    color: sortedTiempoPuntosColors
                }
            };
            
            var tiempoPuntosLayout = {
                margin: {l: 150, r: 50, t: 50, b: 50},
                xaxis: {title: 'Cantidad de respuestas'},
                yaxis: {title: ''}
            };
            
            Plotly.newPlot('tiempoPuntosBar', [tiempoPuntosTrace], tiempoPuntosLayout, {responsive: true});
            

        });

        // Eliminar JS de gráficas de barras dinámicas
        //
        // var colores = ['#fab62d', '#e4032e', '#4ECDC4', '#333333', '#96CEB4', '#BB8FCE', '#F7DC6F', '#BB8FCE', '#85C1E9'];
        // var idx = 0;
        // for (var pregunta in graficas) {
        //     var labels = Object.keys(graficas[pregunta]);
        //     var values = Object.values(graficas[pregunta]);
        //     var trace = {
        //         x: values,
        //         y: labels,
        //         type: 'bar',
        //         orientation: 'h',
        //         marker: {color: colores.slice(0, labels.length)},
        //         text: values.map(String),
        //         textposition: 'auto',
        //         hoverinfo: 'x+y'
        //     };
        //     Plotly.newPlot('bar-' + idx, [trace], {
        //         margin: {l: 120, r: 20, t: 10, b: 40},
        //         height: 40 + 40 * labels.length,
        //         showlegend: false
        //     }, {responsive: true});
        //     idx++;
        // }
        //
    </script>
</body>
</html> 