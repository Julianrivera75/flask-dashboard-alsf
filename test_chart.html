<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prueba de Gr√°fico</title>
    
    <!-- Plotly.js para gr√°ficas -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .chart-container {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        #participacion-diaria-chart {
            width: 100%;
            height: 400px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: #fff;
        }
        
        .test-btn {
            background: #fab62d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 10px;
        }
        
        .test-btn:hover {
            background: #e4032e;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Prueba de Gr√°fico de Participaci√≥n Diaria</h1>
        
        <div class="chart-container">
            <h3>Gr√°fico de Participaci√≥n Diaria</h3>
            <button class="test-btn" onclick="testPlotly()">
                <i class="fas fa-flask"></i> Probar Gr√°fico Simple
            </button>
            <button class="test-btn" onclick="testRealData()">
                <i class="fas fa-database"></i> Probar con Datos Reales
            </button>
            <div id="participacion-diaria-chart">
                <!-- El gr√°fico se generar√° aqu√≠ -->
            </div>
        </div>
    </div>

    <script>
        // Funci√≥n de prueba simple
        function testPlotly() {
            console.log('üß™ Probando Plotly...');
            
            const testData = [{
                x: ['Ene', 'Feb', 'Mar', 'Abr', 'May'],
                y: [10, 20, 15, 25, 30],
                type: 'bar',
                marker: { color: '#fab62d' },
                name: 'Actividades'
            }];
            
            const testLayout = {
                title: 'Gr√°fico de Prueba Simple',
                xaxis: { title: 'Mes' },
                yaxis: { title: 'N√∫mero de Actividades' },
                margin: { t: 50, b: 50, l: 60, r: 30 }
            };
            
            try {
                Plotly.newPlot('participacion-diaria-chart', testData, testLayout, {responsive: true})
                    .then(() => {
                        console.log('‚úÖ Gr√°fico de prueba generado exitosamente');
                        document.getElementById('participacion-diaria-chart').innerHTML += 
                            '<div style="position: absolute; top: 10px; right: 10px; background: #28a745; color: white; padding: 5px; border-radius: 4px; font-size: 12px;">‚úÖ Prueba exitosa</div>';
                    })
                    .catch(error => {
                        console.error('‚ùå Error en gr√°fico de prueba:', error);
                        document.getElementById('participacion-diaria-chart').innerHTML = 
                            `<div style="color: red; text-align: center; padding: 2rem;">Error: ${error.message}</div>`;
                    });
            } catch (error) {
                console.error('‚ùå Error en testPlotly:', error);
                document.getElementById('participacion-diaria-chart').innerHTML = 
                    `<div style="color: red; text-align: center; padding: 2rem;">Error: ${error.message}</div>`;
            }
        }
        
        // Funci√≥n de prueba con datos reales simulados
        function testRealData() {
            console.log('üìä Probando con datos reales simulados...');
            
            // Datos simulados de Google Sheets
            const dataSimulada = [
                { 'Entidad': 'Alcald√≠a', 'Fecha final de ejecuci√≥n': '2024-01-15' },
                { 'Entidad': 'Alcald√≠a', 'Fecha final de ejecuci√≥n': '2024-01-15' },
                { 'Entidad': 'Secretar√≠a de Salud', 'Fecha final de ejecuci√≥n': '2024-01-16' },
                { 'Entidad': 'Secretar√≠a de Educaci√≥n', 'Fecha final de ejecuci√≥n': '2024-01-16' },
                { 'Entidad': 'Alcald√≠a', 'Fecha final de ejecuci√≥n': '2024-01-17' },
                { 'Entidad': 'Secretar√≠a de Cultura', 'Fecha final de ejecuci√≥n': '2024-01-17' },
                { 'Entidad': 'Secretar√≠a de Cultura', 'Fecha final de ejecuci√≥n': '2024-01-17' }
            ];
            
            updateParticipacionDiariaChart(dataSimulada);
        }
        
        // Funci√≥n de participaci√≥n diaria (copiada del archivo principal)
        function updateParticipacionDiariaChart(data) {
            if (!data || data.length === 0) {
                console.log('‚ùå No hay datos para generar gr√°fica de participaci√≥n diaria');
                return;
            }
            
            console.log('üìä Generando gr√°fica de participaci√≥n diaria...');
            console.log('üìã Datos recibidos:', data.length, 'registros');
            
            // Verificar que el contenedor existe
            const container = document.getElementById('participacion-diaria-chart');
            if (!container) {
                console.error('‚ùå Contenedor "participacion-diaria-chart" no encontrado');
                return;
            }
            
            console.log('‚úÖ Contenedor encontrado:', container);
            
            // Contar actividades por d√≠a y entidad
            const actividadesPorDia = {};
            let fechasValidas = 0;
            let fechasInvalidas = 0;
            
            data.forEach((row, index) => {
                const fecha = row['Fecha final de ejecuci√≥n'];
                const entidad = row['Entidad'] || 'Sin especificar';
                
                if (index < 5) {
                    console.log(`üìÖ Registro ${index + 1}: Fecha="${fecha}", Entidad="${entidad}"`);
                }
                
                if (fecha && fecha !== 'None' && fecha !== '' && fecha !== null) {
                    try {
                        // Verificar si es una fecha ISO v√°lida
                        if (fecha.match(/^\d{4}-\d{2}-\d{2}$/)) {
                            const fechaObj = new Date(fecha);
                            if (!isNaN(fechaObj.getTime())) {
                                const fechaFormateada = fechaObj.toISOString().split('T')[0]; // YYYY-MM-DD
                                
                                if (!actividadesPorDia[fechaFormateada]) {
                                    actividadesPorDia[fechaFormateada] = {};
                                }
                                
                                actividadesPorDia[fechaFormateada][entidad] = (actividadesPorDia[fechaFormateada][entidad] || 0) + 1;
                                fechasValidas++;
                            } else {
                                fechasInvalidas++;
                                console.log(`‚ùå Fecha inv√°lida (NaN): ${fecha}`);
                            }
                        } else {
                            fechasInvalidas++;
                            console.log(`‚ùå Formato no ISO: ${fecha}`);
                        }
                    } catch (e) {
                        fechasInvalidas++;
                        console.log(`‚ùå Error procesando fecha: ${fecha} - ${e.message}`);
                    }
                } else {
                    fechasInvalidas++;
                    console.log(`‚ùå Fecha vac√≠a: "${fecha}"`);
                }
            });
            
            console.log(`üìÖ Fechas v√°lidas para gr√°fica diaria: ${fechasValidas}`);
            console.log(`‚ùå Fechas inv√°lidas: ${fechasInvalidas}`);
            console.log(`üìä D√≠as con actividades: ${Object.keys(actividadesPorDia).length}`);
            
            if (Object.keys(actividadesPorDia).length === 0) {
                console.log('‚ö†Ô∏è No hay fechas v√°lidas, mostrando mensaje de error');
                container.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666; text-align: center;">
                        <div>
                            <i class="fas fa-calendar-times" style="font-size: 3rem; margin-bottom: 1rem; color: #fab62d;"></i>
                            <p><strong>No hay fechas v√°lidas para mostrar la participaci√≥n diaria</strong></p>
                            <p style="font-size: 0.9rem; margin-top: 0.5rem;">
                                Fechas v√°lidas: ${fechasValidas} | Fechas inv√°lidas: ${fechasInvalidas}
                            </p>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Ordenar fechas cronol√≥gicamente
            const fechasOrdenadas = Object.keys(actividadesPorDia).sort();
            console.log('üìÖ Fechas ordenadas:', fechasOrdenadas);
            
            // Obtener todas las entidades √∫nicas
            const todasEntidades = new Set();
            Object.values(actividadesPorDia).forEach(dia => {
                Object.keys(dia).forEach(entidad => todasEntidades.add(entidad));
            });
            
            const entidadesArray = Array.from(todasEntidades);
            console.log('üè¢ Entidades encontradas:', entidadesArray.join(', '));
            
            // Crear colores para cada entidad
            const colores = [
                '#fab62d', '#e4032e', '#ff6b35', '#4ecdc4', '#45b7d1',
                '#96ceb4', '#feca57', '#ff9ff3', '#54a0ff', '#5f27cd',
                '#00d2d3', '#ff9f43', '#10ac84', '#ee5a24', '#2f3542'
            ];
            
            // Crear trazas para cada entidad
            const traces = entidadesArray.map((entidad, index) => {
                const datos = fechasOrdenadas.map(fecha => {
                    return actividadesPorDia[fecha][entidad] || 0;
                });
                
                console.log(`üìä Traza para ${entidad}:`, datos);
                
                return {
                    x: fechasOrdenadas.map(fecha => {
                        const fechaObj = new Date(fecha);
                        return fechaObj.toLocaleDateString('es-CO', { 
                            day: '2-digit', 
                            month: '2-digit' 
                        });
                    }),
                    y: datos,
                    type: 'bar',
                    name: entidad,
                    marker: {
                        color: colores[index % colores.length]
                    },
                    hovertemplate: `<b>${entidad}</b><br>Fecha: %{x}<br>Actividades: %{y}<extra></extra>`
                };
            });
            
            const layout = {
                title: {
                    text: 'Participaci√≥n Diaria por Entidad',
                    font: { size: 16, color: '#333' }
                },
                barmode: 'stack',
                xaxis: {
                    title: 'Fecha',
                    tickangle: -45
                },
                yaxis: {
                    title: 'N√∫mero de Actividades'
                },
                legend: {
                    orientation: 'h',
                    y: -0.2
                },
                margin: { t: 50, b: 120, l: 60, r: 30 }
            };
            
            console.log(`üé® Generando gr√°fica con ${traces.length} trazas...`);
            console.log('üìê Layout configurado:', layout);
            
            try {
                Plotly.newPlot('participacion-diaria-chart', traces, layout, {responsive: true})
                    .then(() => {
                        console.log('‚úÖ Gr√°fica de participaci√≥n diaria generada exitosamente');
                    })
                    .catch(error => {
                        console.error('‚ùå Error generando gr√°fica:', error);
                        container.innerHTML = `
                            <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #e4032e; text-align: center;">
                                <div>
                                    <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                                    <p><strong>Error al generar la gr√°fica</strong></p>
                                    <p style="font-size: 0.9rem; margin-top: 0.5rem;">${error.message}</p>
                                </div>
                            </div>
                        `;
                    });
            } catch (error) {
                console.error('‚ùå Error en Plotly.newPlot:', error);
                container.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #e4032e; text-align: center;">
                        <div>
                            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <p><strong>Error al generar la gr√°fica</strong></p>
                            <p style="font-size: 0.9rem; margin-top: 0.5rem;">${error.message}</p>
                        </div>
                    </div>
                `;
            }
        }
        
        // Cargar prueba autom√°ticamente
        window.onload = function() {
            console.log('üöÄ P√°gina cargada, Plotly disponible:', typeof Plotly !== 'undefined');
            if (typeof Plotly !== 'undefined') {
                console.log('‚úÖ Plotly est√° cargado correctamente');
            } else {
                console.error('‚ùå Plotly no est√° cargado');
            }
        };
    </script>
</body>
</html> 